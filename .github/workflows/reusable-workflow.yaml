name: Reusable Deploy Workflow 1
on:
  workflow_call:
    inputs:
      dockerImage:
        description: 'Docker Image Name'
        type: string
        required: false
      dockerImageVersion:
        description: 'Docker Image Version'
        type: string
        required: true
      deployEnvironment:
        description: 'Deployment Environment'
        type: string
        required: true
   
jobs:
  deployment-information:
    runs-on: ubuntu-latest
    outputs:
      clusters: ${{ steps.information.outputs.clusters }}
      selectedClusters: ${{ steps.information.outputs.selectedClusters }}
    steps:
    - name: Information
      id: information
      uses: actions/github-script@v6
      with:
        #result-encoding: string
        script: |
          console.log(`Workflow Inputs are : ${ context?.payload?.inputs }`)
          const selectedEnv = context?.payload?.inputs?.deployEnvironment || 'dev'
          const dev=[{ "name" : "np-1" }]
          const preprod=[{ "name" : "np-1" },{ "name" : "np-2" }]
          
          const clusters = new Map()
          clusters.set('dev', dev)
          clusters.set('preprod', preprod)
          core.setOutput('clusters', clusters);
          
          const selectedClusters = new Map()
          switch(selectedEnv) {
            case 'dev':
              selectedClusters.set('dev', dev)
              break;
            case 'preprod':
              selectedClusters.set('preprod', preprod)
              break;
            default:
              selectedClusters.set('dev', dev)
              selectedClusters.set('preprod', preprod)
          }
          core.setOutput('selectedClusters', selectedClusters);
  deploy-env:
    runs-on: ubuntu-latest
    needs: deployment-information
    strategy:
      matrix:
        targetEnv : ['dev','preprod']
        clstr: ['${{ needs.deployment-information.outputs.clusters.get(matrix.targetEnv) }}']
    steps:
    - name: steps level matrix - ${{ matrix.targetEnv }}
      run: echo Target Environment is ${{ matrix.targetEnv }}
      
        
        
               
